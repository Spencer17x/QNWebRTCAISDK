!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).QNRTCAI={})}(this,function(a){"use strict";var i=function(){return(i=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var r in e=arguments[n])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function e(t,i,c,u){return new(c=c||Promise)(function(n,e){function o(t){try{a(u.next(t))}catch(t){e(t)}}function r(t){try{a(u.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(o,r)}a((u=u.apply(t,i||[])).next())})}function c(n,o){var r,a,i,c={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(r)throw new TypeError("Generator is already executing.");for(;c;)try{if(r=1,a&&(i=2&e[0]?a.return:e[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,e[1])).done)return i;switch(a=0,(e=i?[2&e[0],i.value]:e)[0]){case 0:case 1:i=e;break;case 4:return c.label++,{value:e[1],done:!1};case 5:c.label++,a=e[1],e=[0];continue;case 7:e=c.ops.pop(),c.trys.pop();continue;default:if(!(i=0<(i=c.trys).length&&i[i.length-1])&&(6===e[0]||2===e[0])){c=0;continue}if(3===e[0]&&(!i||e[1]>i[0]&&e[1]<i[3])){c.label=e[1];break}if(6===e[0]&&c.label<i[1]){c.label=i[1],i=e;break}if(i&&c.label<i[2]){c.label=i[2],c.ops.push(e);break}i[2]&&c.ops.pop(),c.trys.pop();continue}e=o.call(n,c)}catch(t){e=[6,t],a=0}finally{r=i=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function t(){this.cache={token:null}}var u=new(t.prototype.get=function(t){return this.cache[t]},t.prototype.set=function(t,e){this.cache[t]=e},t);function s(t,e){var n=e.debug,e=function(t,e){var n={};for(r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.indexOf(r)<0&&(n[r]=t[r]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,r=Object.getOwnPropertySymbols(t);o<r.length;o++)e.indexOf(r[o])<0&&Object.prototype.propertyIsEnumerable.call(t,r[o])&&(n[r[o]]=t[r[o]]);return n}(e,["debug"]),e=n?{request:e||{},debug:n}:{request:e||{}};return fetch("https://ap-open-z0.qiniuapi.com/dora-sdk/api"+t,{headers:{Authorization:u.get("token"),"Content-Type":"application/json"},body:JSON.stringify(e),method:"POST"}).then(function(t){return t.json()})}var n=(o.run=function(t,e){t=t._track.getCurrentFrameDataURL();return s("/ocr-idcard",i({image:t.replace("data:image/png;base64,","")},e))},o);function o(){}var l,r={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5};(E=l=l||{})[E.CLOSED=0]="CLOSED",E[E.PROCESSING=1]="PROCESSING",E[E.OPENED=2]="OPENED";var d=(f.prototype.initWebSocket=function(r,a){return e(this,void 0,void 0,function(){var e,n,o=this;return c(this,function(t){switch(t.label){case 0:return this.status=l.PROCESSING,u.cache.signCallback?[4,u.cache.signCallback(r)]:[3,2];case 1:return n=t.sent(),[3,3];case 2:n=null,t.label=3;case 3:return e=n,this.ws=new WebSocket(r+"&token="+e),this.on("open",function(){console.info("roomlog websocket open"),o.status=l.OPENED,a&&a()}),this.on("close",function(){console.info("roomlog websocket close"),o.status=l.CLOSED}),[2]}})})},f.prototype.on=function(t,e){var n;this.listeners.push({event:t,callback:e}),null!==(n=this.ws)&&void 0!==n&&n.addEventListener(t,e)},f.prototype.send=function(t){var e;this.status===l.OPENED&&null!==(e=this.ws)&&void 0!==e&&e.send(t)},f.prototype.sendEOS=function(){this.ws&&this.status===l.OPENED&&this.send("EOS")},f.prototype.close=function(){var t;this.ws&&this.status===l.OPENED&&(this.status=l.CLOSED,null!==(t=this.ws)&&void 0!==t&&t.close())},f.prototype.destroy=function(){var o=this;this.listeners.map(function(t){var e=t.event,n=t.callback;null!==(t=o.ws)&&void 0!==t&&t.removeEventListener(e,n)})},f);function f(t,e){this.status=l.CLOSED;var n=t.query,n=void 0===n?r:n,t=t.baseUrl,t=void 0===t?"wss://ap-open-ws.service-z0.qiniuapp.com/asr":t,n=Object.entries(i(i(i({},r),n),{e:Math.floor(Date.now()/1e3)})).filter(function(t){return void 0!==t[1]&&null!==t[1]}).map(function(t){return t[0]+"="+t[1]}).join("&"),n=t+"?"+encodeURI(n);this.listeners=[],this.initWebSocket(n,e)}a.Status=void 0,(k=a.Status||(a.Status={}))[k.AVAILABLE=0]="AVAILABLE",k[k.DESTROY=1]="DESTROY",k[k.ERROR=2]="ERROR",k[k.DETECTING=3]="DETECTING";var h={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5},p=(v.prototype.startConnectWebSocket=function(e,t){var n=this,o=t.params,r=t.callback,t=t.audioBuffer,o=i(i(i({},h),{voice_sample:t.sampleRate}),o);e.ws=new d({query:o},function(){var t;e.isRecording=!0,e.status=a.Status.DETECTING,null!==(t=e.ws)&&void 0!==t&&t.on("message",function(t){var t=JSON.parse(t.data);null!=r&&r.onAudioToText&&r.onAudioToText(t),1===t.ended&&(n.timeoutWebSocketCloseJob&&clearTimeout(n.timeoutWebSocketCloseJob),null!==(t=e.ws)&&void 0!==t&&t.close())}),null!=r&&r.onStatusChange&&r.onStatusChange(e.status,"正在实时转化"),null!==(t=e.ws)&&void 0!==t&&t.on("error",function(){e.isRecording=!1,e.status=a.Status.ERROR,null!=r&&r.onStatusChange&&r.onStatusChange(e.status,"连接异常断线")}),null!==(t=e.ws)&&void 0!==t&&t.on("close",function(){e.isRecording=!1,e.status=a.Status.DESTROY,null!=r&&r.onStatusChange&&r.onStatusChange(e.status,"已经销毁不可用")})}),e.ws.on("open",function(){var t;console.log("on open"),e.isRecording=!0,e.status=a.Status.DETECTING,null!==(t=e.ws)&&void 0!==t&&t.on("message",function(t){null!=r&&r.onAudioToText&&r.onAudioToText(JSON.parse(t.data))}),null!=r&&r.onStatusChange&&r.onStatusChange(e.status,"正在实时转化")})},v.prototype.sendMessageToWebSocket=function(t,e){var n=e.audioBuffer;t.leftDataList.push(n.getChannelData(0).slice(0)),200<=Date.now()-t.startTime&&(e=this.mergeArray(t.leftDataList),n=Int16Array.from(e.map(function(t){return 0<t?32767*t:32768*t})).buffer,null!==(e=t.ws)&&void 0!==e&&e.send(n),t.startTime=Date.now(),t.leftDataList=[],t.rightDataList=[])},v.prototype.mergeArray=function(t){for(var e=t.length*t[0].length,n=new Float32Array(e),o=0,r=0;r<t.length;r++)n.set(t[r],o),o+=t[r].length;return n},v.prototype.interleaveLeftAndRight=function(t,e){for(var n=t.length+e.length,o=new Float32Array(n),r=0;r<t.length;r++){var a=2*r;o[a]=t[r],o[1+a]=e[r]}return o},v.startAudioToText=function(t,n,o){var e=t._track,r=new v;r.startTime=Date.now();t=function(t){var e;r.ws||r.startConnectWebSocket(r,{params:n,callback:o,audioBuffer:t}),(null===(e=r.ws)||void 0===e?void 0:e.status)===l.OPENED&&r.sendMessageToWebSocket(r,{audioBuffer:t})};return e.on("audioBuffer",t),r.audioBufferHandler=t,r.audioTrack=e,r},v.prototype.getStatus=function(){return this.status},v.prototype.stopAudioToText=function(){var t;this.audioTrack&&this.audioBufferHandler&&this.audioTrack.off("audioBuffer",this.audioBufferHandler),null!==(t=this.ws)&&void 0!==t&&t.sendEOS(),this.timeoutJob()},v.prototype.timeoutJob=function(t){var e=this;this.timeoutWebSocketCloseJob=setTimeout(function(){var t;null!==(t=e.ws)&&void 0!==t&&t.close()},t||500)},v);function v(){this.status=a.Status.AVAILABLE,this.isRecording=!1,this.startTime=Date.now(),this.leftDataList=[],this.rightDataList=[]}function m(t,e){for(var n=t.split(","),t=n[0].match(/:(.*?);/)[1],o=atob(n[1]),r=o.length,a=new Uint8Array(r);r--;)a[r]=o.charCodeAt(r);return new File([a],e,{type:t})}function g(n){return new Promise(function(t){var e=new FileReader;e.readAsDataURL(n),e.onload=function(){t(e.result)}})}var y=Object.freeze({__proto__:null,compress:function(i,c){return new Promise(function(r){var a=new Image;a.src=i,a.onload=function(){var t,e,n=c.maxWidth,o=c.maxHeight;a.width*a.height>=n*o?(e=document.createElement("canvas"),t=Math.max(a.width/n,a.height/o),n=a.width/t,o=a.height/t,e.setAttribute("width",n+""),e.setAttribute("height",o+""),null!==(t=e.getContext("2d"))&&void 0!==t&&t.drawImage(a,0,0,n,o),e=e.toDataURL("image/png"),r(e)):r(i)}})},dataURLToFile:m,blobToBase64:g});a.Speaker=void 0,(R=a.Speaker||(a.Speaker={})).Male1="male1",R.Male2="male2",R.Female3="female3",R.Male4="male4",R.Female5="female5",R.Female6="female6",R.Kefu1="kefu1",R.Girl1="girl1",a.AudioEncoding=void 0,(E=a.AudioEncoding||(a.AudioEncoding={})).Wav="wav",E.Pcm="pcm",E.Mp3="mp3",a.ActionType=void 0,(k=a.ActionType||(a.ActionType={})).Nod="nod",k.Shake="shake",k.Blink="blink",k.Mouth="mouth",a.VideoType=void 0,(R=a.VideoType||(a.VideoType={}))[R.Mp4=1]="Mp4",R[R.H264=2]="H264";var w=(b.start=function(t,e,n){var o=new b,r=t.createMediaRecorder(),t=((t={})[a.VideoType.Mp4]="video/mp4",t[a.VideoType.H264]="video/webm;codecs=h264",t);return r.constructor.recorderTimeslice=200,r.setMimeType(t[o.video_type]),o.recorder=r,o.recorder.start({videoTrack:e}),o.params=n,o},b.prototype.commit=function(){return e(this,void 0,void 0,function(){var e,n;return c(this,function(t){switch(t.label){case 0:return n=this.recorder.stop(),[4,(r=n,new Promise(function(e,n){var o=new FileReader;o.onload=function(t){e(t.target.result+"")},o.onerror=function(t){n("Failed to read file!\n\n"+o.error)},o.readAsDataURL(r)}))];case 1:return e=t.sent(),n="base64,",n=e.indexOf(n)+n.length,n=e.slice(n),[2,s("/face-actlive",i({video_b64:n},this.params))]}var r})})},b);function b(){}var E=(S.start=function(t,e){var e=e||15,n=new S,o=t._track;return n.frameRate=e,n.videoData=[],n.timer=setInterval(function(){var t=o.getCurrentFrameDataURL().replace("data:image/png;base64,","");n.videoData.push({image:t})},1e3/e),n},S.prototype.commit=function(){return e(this,void 0,void 0,function(){return c(this,function(t){return clearInterval(this.timer),[2,s("/face-flashlive",{video_data:this.videoData})]})})},S);function S(){}var k={exports:{}},T=k.exports=function(n){var o={};function r(t){if(o[t])return o[t].exports;var e=o[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,r),e.l=!0,e.exports}return r.m=n,r.c=o,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,n){var h;function p(e){return["image/png","image/jpeg","image/gif"].some(t=>t===e)}n.r(e),n.d(e,"canvastoDataURL",function(){return v}),n.d(e,"canvastoFile",function(){return r}),n.d(e,"dataURLtoFile",function(){return m}),n.d(e,"dataURLtoImage",function(){return g}),n.d(e,"downloadFile",function(){return a}),n.d(e,"filetoDataURL",function(){return y}),n.d(e,"imagetoCanvas",function(){return w}),n.d(e,"urltoBlob",function(){return i}),n.d(e,"urltoImage",function(){return s}),n.d(e,"compress",function(){return d}),n.d(e,"compressAccurately",function(){return f}),n.d(e,"EImageType",function(){return h}),(e=h=h||{}).PNG="image/png",e.JPEG="image/jpeg",e.GIF="image/gif";var o=function(t,i,c,u){return new(c=c||Promise)(function(n,e){function o(t){try{a(u.next(t))}catch(t){e(t)}}function r(t){try{a(u.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(o,r)}a((u=u.apply(t,i||[])).next())})};function v(t,e=.92,n=h.JPEG){return o(this,void 0,void 0,function*(){return p(n)||(n=h.JPEG),t.toDataURL(n,e)})}function r(t,n=.92,o=h.JPEG){return new Promise(e=>t.toBlob(t=>e(t),o,n))}var c=function(t,i,c,u){return new(c=c||Promise)(function(n,e){function o(t){try{a(u.next(t))}catch(t){e(t)}}function r(t){try{a(u.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(o,r)}a((u=u.apply(t,i||[])).next())})};function m(a,i){return c(this,void 0,void 0,function*(){const t=a.split(",");let e=t[0].match(/:(.*?);/)[1];const n=atob(t[1]);let o=n.length;const r=new Uint8Array(o);for(;o--;)r[o]=n.charCodeAt(o);return p(i)&&(e=i),new Blob([r],{type:e})})}function g(o){return new Promise((t,e)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>e(new Error("dataURLtoImage(): dataURL is illegal")),n.src=o})}function a(t,e){const n=document.createElement("a");n.href=window.URL.createObjectURL(t),n.download=e||Date.now().toString(36),document.body.appendChild(n);const o=document.createEvent("MouseEvents");o.initEvent("click",!1,!1),n.dispatchEvent(o),document.body.removeChild(n)}function y(n){return new Promise(e=>{const t=new FileReader;t.onloadend=t=>e(t.target.result),t.readAsDataURL(n)})}var u=function(t,i,c,u){return new(c=c||Promise)(function(n,e){function o(t){try{a(u.next(t))}catch(t){e(t)}}function r(t){try{a(u.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(o,r)}a((u=u.apply(t,i||[])).next())})};function w(a,i={}){return u(this,void 0,void 0,function*(){const e=Object.assign({},i),t=document.createElement("canvas"),n=t.getContext("2d");let o,r;for(const a in e)Object.prototype.hasOwnProperty.call(e,a)&&(e[a]=Number(e[a]));if(e.scale){const i=0<e.scale&&e.scale<10?e.scale:1;r=a.width*i,o=a.height*i}else r=e.width||e.height*a.width/a.height||a.width,o=e.height||e.width*a.height/a.width||a.height;switch([5,6,7,8].some(t=>t===e.orientation)?(t.height=r,t.width=o):(t.height=o,t.width=r),e.orientation){case 3:n.rotate(180*Math.PI/180),n.drawImage(a,-t.width,-t.height,t.width,t.height);break;case 6:n.rotate(90*Math.PI/180),n.drawImage(a,0,-t.width,t.height,t.width);break;case 8:n.rotate(270*Math.PI/180),n.drawImage(a,-t.height,0,t.height,t.width);break;case 2:n.translate(t.width,0),n.scale(-1,1),n.drawImage(a,0,0,t.width,t.height);break;case 4:n.translate(t.width,0),n.scale(-1,1),n.rotate(180*Math.PI/180),n.drawImage(a,-t.width,-t.height,t.width,t.height);break;case 5:n.translate(t.width,0),n.scale(-1,1),n.rotate(90*Math.PI/180),n.drawImage(a,0,-t.width,t.height,t.width);break;case 7:n.translate(t.width,0),n.scale(-1,1),n.rotate(270*Math.PI/180),n.drawImage(a,-t.height,0,t.height,t.width);break;default:n.drawImage(a,0,0,t.width,t.height)}return t})}function i(t){return fetch(t).then(t=>t.blob())}function s(o){return new Promise((t,e)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>e(new Error("urltoImage(): Image failed to load, please check the image URL")),n.src=o})}var l=function(t,i,c,u){return new(c=c||Promise)(function(n,e){function o(t){try{a(u.next(t))}catch(t){e(t)}}function r(t){try{a(u.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof c?e:new c(function(t){t(e)})).then(o,r)}a((u=u.apply(t,i||[])).next())})};function d(r,a={}){return l(this,void 0,void 0,function*(){if(!(r instanceof Blob))throw new Error("compress(): First arg must be a Blob object or a File object.");if((a="object"!=typeof a?Object.assign({quality:a}):a).quality=Number(a.quality),Number.isNaN(a.quality))return r;const t=yield y(r);let e=t.split(",")[0].match(/:(.*?);/)[1],n=h.JPEG;p(a.type)&&(n=a.type,e=a.type);var o=yield m(yield v(yield w(yield g(t),Object.assign({},a)),a.quality,n),e);return o.size>r.size?r:o})}function f(d,f={}){return l(this,void 0,void 0,function*(){if(!(d instanceof Blob))throw new Error("compressAccurately(): First arg must be a Blob object or a File object.");if((f="object"!=typeof f?Object.assign({size:f}):f).size=Number(f.size),Number.isNaN(f.size))return d;if(1024*f.size>d.size)return d;f.accuracy=Number(f.accuracy),(!f.accuracy||f.accuracy<.8||.99<f.accuracy)&&(f.accuracy=.95);const e=f.size*(2-f.accuracy)*1024,n=1024*f.size,o=f.size*f.accuracy*1024,t=yield y(d);let r=t.split(",")[0].match(/:(.*?);/)[1],a=h.JPEG;p(f.type)&&(a=f.type,r=f.type);var i=yield w(yield g(t),Object.assign({},f));let c,u=.5;const s=[null,null];for(let t=1;t<=7;t++){c=yield v(i,u,a);const f=.75*c.length;if(7===t){(e<f||o>f)&&(c=[c,...s].filter(t=>t).sort((t,e)=>Math.abs(.75*t.length-n)-Math.abs(.75*e.length-n))[0]);break}if(e<f)s[1]=c,u-=Math.pow(.5,t+1);else{if(!(o>f))break;s[0]=c,u+=Math.pow(.5,t+1)}}var l=yield m(c,r);return l.size>d.size?d:l})}}]),O=(D.run=function(t,e){t=m(t._track.getCurrentFrameDataURL(),"photo");return T.compressAccurately(t,24).then(g).then(function(t){return s("/face-hdphotoauth",i({photo_b64:t.split(",")[1]},e))})},D);function D(){}var R=(A.start=function(t,e,n,o){var r=new this;return r.faceActionLiveDetector=w.start(t,e,n),r.authoritativeFaceParams=o,r.videoTrack=e,r},A.prototype.commit=function(){return Promise.all([this.faceActionLiveDetector.commit(),O.run(this.videoTrack,this.authoritativeFaceParams)]).then(function(t){return{faceActionResult:t[0],authoritativeFaceResult:t[1]}})},A);function A(){}P.run=function(t){return s("/general-ocr",{"data.uri":"data:application/octet-stream;base64,"+t._track.getCurrentFrameDataURL().split(",")[1]})},k=P;function P(){}a.AudioToTextAnalyzer=p,a.FaceActionLiveDetector=w,a.FaceFlashLiveDetector=E,a.IDCardDetector=n,a.ImageUtils=y,a.QNAuthoritativeFaceComparer=O,a.QNAuthorityActionFaceComparer=R,a.QNOCRDetector=k,a.defaultAudioToTextParams=h,a.faceComparer=function(t,n,o){var r=t._track;return e(this,void 0,void 0,function(){var e;return c(this,function(t){return e=r.getCurrentFrameDataURL(),[2,s("/face-compare",i({data_uri_a:e,data_uri_b:n},o))]})})},a.faceDetector=function(t,e){return t=t._track.getCurrentFrameDataURL(),s("/face-detect",i({image_b64:t.replace("data:image/png;base64,","")},e))},a.init=function(t,e){u.set("token",t),u.set("signCallback",e)},a.textToSpeak=function(t){return s("/voice-tts",i({speaker:a.Speaker.Kefu1,audio_encoding:a.AudioEncoding.Wav,sample_rate:16e3,volume:50,speed:0},t))},a.version="1.1.0",Object.defineProperty(a,"__esModule",{value:!0})});
