!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).QNRTCAI={})}(this,function(i){"use strict";var r=function(){return(r=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)};function e(t,r,s,u){return new(s=s||Promise)(function(n,e){function o(t){try{i(u.next(t))}catch(t){e(t)}}function a(t){try{i(u.throw(t))}catch(t){e(t)}}function i(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(o,a)}i((u=u.apply(t,r||[])).next())})}function s(n,o){var a,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(r=2&e[0]?i.return:e[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,e[1])).done)return r;switch(i=0,(e=r?[2&e[0],r.value]:e)[0]){case 0:case 1:r=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,i=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3])){s.label=e[1];break}if(6===e[0]&&s.label<r[1]){s.label=r[1],r=e;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(e);break}r[2]&&s.ops.pop(),s.trys.pop();continue}e=o.call(n,s)}catch(t){e=[6,t],i=0}finally{a=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}function u(r,s){return new Promise(function(a){var i=new Image;i.src=r,i.onload=function(){var t,e,n=s.maxWidth,o=s.maxHeight;i.width*i.height>=n*o?(e=document.createElement("canvas"),t=Math.max(i.width/n,i.height/o),n=i.width/t,o=i.height/t,e.setAttribute("width",n+""),e.setAttribute("height",o+""),null!==(t=e.getContext("2d"))&&void 0!==t&&t.drawImage(i,0,0,n,o),e=e.toDataURL("image/png"),a(e)):a(r)}})}var t=Object.freeze({__proto__:null,compress:u}),n="https://ap-open-z0.qiniuapi.com/dora-sdk/api";function o(){this.cache={token:null}}var c=new(o.prototype.get=function(t){return this.cache[t]},o.prototype.set=function(t,e){this.cache[t]=e},o);function l(t,e){return fetch(n+t,{headers:{Authorization:c.get("token"),"Content-Type":"application/json"},body:JSON.stringify({request:e||{}}),method:"POST"}).then(function(t){return t.json()})}var a=(f.run=function(t,e){return u(t._track.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640}).then(function(t){return l("/ocr-idcard",r({image:t.replace("data:image/png;base64,","")},e))})},f);function f(){}var d,h={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5};(g=d=d||{})[g.CLOSED=0]="CLOSED",g[g.PROCESSING=1]="PROCESSING",g[g.OPENED=2]="OPENED";var p=(v.prototype.initWebSocket=function(a,i){return e(this,void 0,void 0,function(){var e,n,o=this;return s(this,function(t){switch(t.label){case 0:return this.status=d.PROCESSING,c.cache.signCallback?[4,c.cache.signCallback(a)]:[3,2];case 1:return n=t.sent(),[3,3];case 2:n=null,t.label=3;case 3:return e=n,this.ws=new WebSocket(a+"&token="+e),this.on("open",function(){console.info("roomlog websocket open"),o.status=d.OPENED,i&&i()}),this.on("close",function(){console.info("roomlog websocket close"),o.status=d.CLOSED}),[2]}})})},v.prototype.on=function(t,e){var n;this.listeners.push({event:t,callback:e}),null!==(n=this.ws)&&void 0!==n&&n.addEventListener(t,e)},v.prototype.send=function(t){var e;this.status===d.OPENED&&null!==(e=this.ws)&&void 0!==e&&e.send(t)},v.prototype.sendEOS=function(){this.ws&&this.status===d.OPENED&&this.send("EOS")},v.prototype.close=function(){var t;this.ws&&this.status===d.OPENED&&(this.status=d.CLOSED,null!==(t=this.ws)&&void 0!==t&&t.close())},v.prototype.destroy=function(){var o=this;this.listeners.map(function(t){var e=t.event,n=t.callback;null!==(t=o.ws)&&void 0!==t&&t.removeEventListener(e,n)})},v);function v(t,e){this.status=d.CLOSED;var n=t.query,n=void 0===n?h:n,t=t.baseUrl,n=(void 0===t?"wss://ap-open-ws.service-z0.qiniuapp.com/asr":t)+"?"+Object.entries(r(r(r({},h),n),{e:Math.floor(Date.now()/1e3)})).filter(function(t){return void 0!==t[1]&&null!==t[1]}).map(function(t){return t[0]+"="+t[1]}).join("&");this.listeners=[],this.initWebSocket(n,e)}i.Status=void 0,(w=i.Status||(i.Status={}))[w.AVAILABLE=0]="AVAILABLE",w[w.DESTROY=1]="DESTROY",w[w.ERROR=2]="ERROR",w[w.DETECTING=3]="DETECTING";var m={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5},g=(b.prototype.startConnectWebSocket=function(e,t){var n=this,o=t.params,a=t.callback,t=t.audioBuffer,o=r(r(r({},m),{voice_sample:t.sampleRate}),o);e.ws=new p({query:o},function(){var t;e.isRecording=!0,e.status=i.Status.DETECTING,null!==(t=e.ws)&&void 0!==t&&t.on("message",function(t){var t=JSON.parse(t.data);null!=a&&a.onAudioToText&&a.onAudioToText(t),1===t.ended&&(n.timeoutWebSocketCloseJob&&clearTimeout(n.timeoutWebSocketCloseJob),null!==(t=e.ws)&&void 0!==t&&t.close())}),null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"正在实时转化"),null!==(t=e.ws)&&void 0!==t&&t.on("error",function(){e.isRecording=!1,e.status=i.Status.ERROR,null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"连接异常断线")}),null!==(t=e.ws)&&void 0!==t&&t.on("close",function(){e.isRecording=!1,e.status=i.Status.DESTROY,null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"已经销毁不可用")})}),e.ws.on("open",function(){var t;console.log("on open"),e.isRecording=!0,e.status=i.Status.DETECTING,null!==(t=e.ws)&&void 0!==t&&t.on("message",function(t){null!=a&&a.onAudioToText&&a.onAudioToText(JSON.parse(t.data))}),null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"正在实时转化")})},b.prototype.sendMessageToWebSocket=function(t,e){var n=e.audioBuffer;t.leftDataList.push(n.getChannelData(0).slice(0)),200<=Date.now()-t.startTime&&(e=this.mergeArray(t.leftDataList),n=Int16Array.from(e.map(function(t){return 0<t?32767*t:32768*t})).buffer,null!==(e=t.ws)&&void 0!==e&&e.send(n),t.startTime=Date.now(),t.leftDataList=[],t.rightDataList=[])},b.prototype.mergeArray=function(t){for(var e=t.length*t[0].length,n=new Float32Array(e),o=0,a=0;a<t.length;a++)n.set(t[a],o),o+=t[a].length;return n},b.prototype.interleaveLeftAndRight=function(t,e){for(var n=t.length+e.length,o=new Float32Array(n),a=0;a<t.length;a++){var i=2*a;o[i]=t[a],o[1+i]=e[a]}return o},b.startAudioToText=function(t,n,o){var e=t._track,a=new b;a.startTime=Date.now();t=function(t){var e;a.ws||a.startConnectWebSocket(a,{params:n,callback:o,audioBuffer:t}),(null===(e=a.ws)||void 0===e?void 0:e.status)===d.OPENED&&a.sendMessageToWebSocket(a,{audioBuffer:t})};return e.on("audioBuffer",t),a.audioBufferHandler=t,a.audioTrack=e,a},b.prototype.getStatus=function(){return this.status},b.prototype.stopAudioToText=function(){var t;this.audioTrack&&this.audioBufferHandler&&this.audioTrack.off("audioBuffer",this.audioBufferHandler),null!==(t=this.ws)&&void 0!==t&&t.sendEOS(),this.timeoutJob()},b.prototype.timeoutJob=function(t){var e=this;this.timeoutWebSocketCloseJob=setTimeout(function(){var t;null!==(t=e.ws)&&void 0!==t&&t.close()},t||500)},b);function b(){this.status=i.Status.AVAILABLE,this.isRecording=!1,this.startTime=Date.now(),this.leftDataList=[],this.rightDataList=[]}var w;function S(t){return t.replace("data:image/png;base64,","")}i.Speaker=void 0,(w=i.Speaker||(i.Speaker={})).Male1="male1",w.Male2="male2",w.Female3="female3",w.Male4="male4",w.Female5="female5",w.Female6="female6",w.Kefu1="kefu1",w.Girl1="girl1",i.AudioEncoding=void 0,(w=i.AudioEncoding||(i.AudioEncoding={})).Wav="wav",w.Pcm="pcm",w.Mp3="mp3",i.AudioToTextAnalyzer=g,i.IDCardDetector=a,i.ImageUtils=t,i.defaultAudioToTextParams=m,i.faceComparer=function(t,o,a){var i=t._track;return e(this,void 0,void 0,function(){var e,n;return s(this,function(t){switch(t.label){case 0:return[4,u(i.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640})];case 1:return e=t.sent(),[4,u(o,{maxWidth:480,maxHeight:640})];case 2:return n=t.sent(),[2,l("/face-compare",r({data_uri_a:S(e),data_uri_b:S(n)},a))]}})})},i.faceDetector=function(t,e){return u(t._track.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640}).then(function(t){return l("/face-detect",r({image_b64:t.replace("data:image/png;base64,","")},e))})},i.init=function(t,e){c.set("token",t),c.set("signCallback",e)},i.textToSpeak=function(t){return l("/voice-tts",r({speaker:i.Speaker.Kefu1,audio_encoding:i.AudioEncoding.Wav,sample_rate:16e3,volume:50,speed:0},t))},i.version="1.0.6-beta",Object.defineProperty(i,"__esModule",{value:!0})});
