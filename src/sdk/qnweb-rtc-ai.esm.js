var __assign=function(){return(__assign=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var a in e=arguments[n])Object.prototype.hasOwnProperty.call(e,a)&&(t[a]=e[a]);return t}).apply(this,arguments)};function __rest(t,e){var n={};for(a in t)Object.prototype.hasOwnProperty.call(t,a)&&e.indexOf(a)<0&&(n[a]=t[a]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols)for(var o=0,a=Object.getOwnPropertySymbols(t);o<a.length;o++)e.indexOf(a[o])<0&&Object.prototype.propertyIsEnumerable.call(t,a[o])&&(n[a[o]]=t[a[o]]);return n}function __awaiter(t,i,s,u){return new(s=s||Promise)(function(n,e){function o(t){try{r(u.next(t))}catch(t){e(t)}}function a(t){try{r(u.throw(t))}catch(t){e(t)}}function r(t){var e;t.done?n(t.value):((e=t.value)instanceof s?e:new s(function(t){t(e)})).then(o,a)}r((u=u.apply(t,i||[])).next())})}function __generator(n,o){var a,r,i,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,r&&(i=2&e[0]?r.return:e[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,e[1])).done)return i;switch(r=0,(e=i?[2&e[0],i.value]:e)[0]){case 0:case 1:i=e;break;case 4:return s.label++,{value:e[1],done:!1};case 5:s.label++,r=e[1],e=[0];continue;case 7:e=s.ops.pop(),s.trys.pop();continue;default:if(!(i=0<(i=s.trys).length&&i[i.length-1])&&(6===e[0]||2===e[0])){s=0;continue}if(3===e[0]&&(!i||e[1]>i[0]&&e[1]<i[3])){s.label=e[1];break}if(6===e[0]&&s.label<i[1]){s.label=i[1],i=e;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(e);break}i[2]&&s.ops.pop(),s.trys.pop();continue}e=o.call(n,s)}catch(t){e=[6,t],r=0}finally{a=i=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}var doraSDKApiURL="https://ap-open-z0.qiniuapi.com/dora-sdk/api",Store=function(){function t(){this.cache={token:null}}return t.prototype.get=function(t){return this.cache[t]},t.prototype.set=function(t,e){this.cache[t]=e},t}(),store=new Store;function post(t,e){var n=e.debug,e=__rest(e,["debug"]),e=n?{request:e||{},debug:n}:{request:e||{}};return fetch(doraSDKApiURL+t,{headers:{Authorization:store.get("token"),"Content-Type":"application/json"},body:JSON.stringify(e),method:"POST"}).then(function(t){return t.json()})}var ConnectStatus,IDCardDetector=function(){function t(){}return t.run=function(t,e){t=t._track.getCurrentFrameDataURL();return post("/ocr-idcard",__assign({image:t.replace("data:image/png;base64,","")},e))},t}(),defaultQuery={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5};!function(t){t[t.CLOSED=0]="CLOSED",t[t.PROCESSING=1]="PROCESSING",t[t.OPENED=2]="OPENED"}(ConnectStatus=ConnectStatus||{});var Status,TranslateWebSocket=function(){function t(t,e){this.status=ConnectStatus.CLOSED;var n=t.query,n=void 0===n?defaultQuery:n,t=t.baseUrl,t=void 0===t?"wss://ap-open-ws.service-z0.qiniuapp.com/asr":t,n=Object.entries(__assign(__assign(__assign({},defaultQuery),n),{e:Math.floor(Date.now()/1e3)})).filter(function(t){return void 0!==t[1]&&null!==t[1]}).map(function(t){return t[0]+"="+t[1]}).join("&"),n=t+"?"+encodeURI(n);this.listeners=[],this.initWebSocket(n,e)}return t.prototype.initWebSocket=function(a,r){return __awaiter(this,void 0,void 0,function(){var e,n,o=this;return __generator(this,function(t){switch(t.label){case 0:return this.status=ConnectStatus.PROCESSING,store.cache.signCallback?[4,store.cache.signCallback(a)]:[3,2];case 1:return n=t.sent(),[3,3];case 2:n=null,t.label=3;case 3:return e=n,this.ws=new WebSocket(a+"&token="+e),this.on("open",function(){console.info("roomlog websocket open"),o.status=ConnectStatus.OPENED,r&&r()}),this.on("close",function(){console.info("roomlog websocket close"),o.status=ConnectStatus.CLOSED}),[2]}})})},t.prototype.on=function(t,e){var n;this.listeners.push({event:t,callback:e}),null!==(n=this.ws)&&void 0!==n&&n.addEventListener(t,e)},t.prototype.send=function(t){var e;this.status===ConnectStatus.OPENED&&null!==(e=this.ws)&&void 0!==e&&e.send(t)},t.prototype.sendEOS=function(){this.ws&&this.status===ConnectStatus.OPENED&&this.send("EOS")},t.prototype.close=function(){var t;this.ws&&this.status===ConnectStatus.OPENED&&(this.status=ConnectStatus.CLOSED,null!==(t=this.ws)&&void 0!==t&&t.close())},t.prototype.destroy=function(){var o=this;this.listeners.map(function(t){var e=t.event,n=t.callback;null!==(t=o.ws)&&void 0!==t&&t.removeEventListener(e,n)})},t}();!function(t){t[t.AVAILABLE=0]="AVAILABLE",t[t.DESTROY=1]="DESTROY",t[t.ERROR=2]="ERROR",t[t.DETECTING=3]="DETECTING"}(Status=Status||{});var defaultAudioToTextParams={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5},AudioToTextAnalyzer=function(){function r(){this.status=Status.AVAILABLE,this.isRecording=!1,this.startTime=Date.now(),this.leftDataList=[],this.rightDataList=[]}return r.prototype.startConnectWebSocket=function(e,t){var n=this,o=t.params,a=t.callback,t=t.audioBuffer,o=__assign(__assign(__assign({},defaultAudioToTextParams),{voice_sample:t.sampleRate}),o);e.ws=new TranslateWebSocket({query:o},function(){var t;e.isRecording=!0,e.status=Status.DETECTING,null!==(t=e.ws)&&void 0!==t&&t.on("message",function(t){var t=JSON.parse(t.data);null!=a&&a.onAudioToText&&a.onAudioToText(t),1===t.ended&&(n.timeoutWebSocketCloseJob&&clearTimeout(n.timeoutWebSocketCloseJob),null!==(t=e.ws)&&void 0!==t&&t.close())}),null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"正在实时转化"),null!==(t=e.ws)&&void 0!==t&&t.on("error",function(){e.isRecording=!1,e.status=Status.ERROR,null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"连接异常断线")}),null!==(t=e.ws)&&void 0!==t&&t.on("close",function(){e.isRecording=!1,e.status=Status.DESTROY,null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"已经销毁不可用")})}),e.ws.on("open",function(){var t;console.log("on open"),e.isRecording=!0,e.status=Status.DETECTING,null!==(t=e.ws)&&void 0!==t&&t.on("message",function(t){null!=a&&a.onAudioToText&&a.onAudioToText(JSON.parse(t.data))}),null!=a&&a.onStatusChange&&a.onStatusChange(e.status,"正在实时转化")})},r.prototype.sendMessageToWebSocket=function(t,e){var n=e.audioBuffer;t.leftDataList.push(n.getChannelData(0).slice(0)),200<=Date.now()-t.startTime&&(e=this.mergeArray(t.leftDataList),n=Int16Array.from(e.map(function(t){return 0<t?32767*t:32768*t})).buffer,null!==(e=t.ws)&&void 0!==e&&e.send(n),t.startTime=Date.now(),t.leftDataList=[],t.rightDataList=[])},r.prototype.mergeArray=function(t){for(var e=t.length*t[0].length,n=new Float32Array(e),o=0,a=0;a<t.length;a++)n.set(t[a],o),o+=t[a].length;return n},r.prototype.interleaveLeftAndRight=function(t,e){for(var n=t.length+e.length,o=new Float32Array(n),a=0;a<t.length;a++){var r=2*a;o[r]=t[a],o[1+r]=e[a]}return o},r.startAudioToText=function(t,n,o){var e=t._track,a=new r;a.startTime=Date.now();t=function(t){var e;a.ws||a.startConnectWebSocket(a,{params:n,callback:o,audioBuffer:t}),(null===(e=a.ws)||void 0===e?void 0:e.status)===ConnectStatus.OPENED&&a.sendMessageToWebSocket(a,{audioBuffer:t})};return e.on("audioBuffer",t),a.audioBufferHandler=t,a.audioTrack=e,a},r.prototype.getStatus=function(){return this.status},r.prototype.stopAudioToText=function(){var t;this.audioTrack&&this.audioBufferHandler&&this.audioTrack.off("audioBuffer",this.audioBufferHandler),null!==(t=this.ws)&&void 0!==t&&t.sendEOS(),this.timeoutJob()},r.prototype.timeoutJob=function(t){var e=this;this.timeoutWebSocketCloseJob=setTimeout(function(){var t;null!==(t=e.ws)&&void 0!==t&&t.close()},t||500)},r}();function compress(i,s){return new Promise(function(a){var r=new Image;r.src=i,r.onload=function(){var t,e,n=s.maxWidth,o=s.maxHeight;r.width*r.height>=n*o?(e=document.createElement("canvas"),t=Math.max(r.width/n,r.height/o),n=r.width/t,o=r.height/t,e.setAttribute("width",n+""),e.setAttribute("height",o+""),null!==(t=e.getContext("2d"))&&void 0!==t&&t.drawImage(r,0,0,n,o),e=e.toDataURL("image/png"),a(e)):a(i)}})}var image=Object.freeze({__proto__:null,compress:compress});function init(t,e){store.set("token",t),store.set("signCallback",e)}var Speaker,AudioEncoding,ActionType,VideoType,version="1.0.13";function textToSpeak(t){return post("/voice-tts",__assign({speaker:Speaker.Kefu1,audio_encoding:AudioEncoding.Wav,sample_rate:16e3,volume:50,speed:0},t))}function faceDetector(t,e){t=t._track.getCurrentFrameDataURL();return post("/face-detect",__assign({image_b64:t.replace("data:image/png;base64,","")},e))}function faceComparer(t,n,o){var a=t._track;return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){return e=a.getCurrentFrameDataURL(),[2,post("/face-compare",__assign({data_uri_a:e,data_uri_b:n},o))]})})}function blobToDataURI(t){return new Promise(function(e,n){var o=new FileReader;o.onload=function(t){e(t.target.result+"")},o.onerror=function(t){n("Failed to read file!\n\n"+o.error)},o.readAsDataURL(t)})}!function(t){t.Male1="male1",t.Male2="male2",t.Female3="female3",t.Male4="male4",t.Female5="female5",t.Female6="female6",t.Kefu1="kefu1",t.Girl1="girl1"}(Speaker=Speaker||{}),function(t){t.Wav="wav",t.Pcm="pcm",t.Mp3="mp3"}(AudioEncoding=AudioEncoding||{}),function(t){t.Nod="nod",t.Shake="shake",t.Blink="blink",t.Mouth="mouth"}(ActionType=ActionType||{}),function(t){t[t.Mp4=1]="Mp4",t[t.H264=2]="H264"}(VideoType=VideoType||{});var FaceActionLiveDetector=function(){function r(){}return r.start=function(t,e,n){var o=new r,a=t.createMediaRecorder(),t=((t={})[VideoType.Mp4]="video/mp4",t[VideoType.H264]="video/webm;codecs=h264",t);return a.constructor.recorderTimeslice=200,a.setMimeType(t[o.video_type]),o.recorder=a,o.recorder.start({videoTrack:e}),o.params=n,o},r.prototype.commit=function(){return __awaiter(this,void 0,void 0,function(){var e,n,o,a;return __generator(this,function(t){switch(t.label){case 0:return[4,blobToDataURI(e=this.recorder.stop())];case 1:return n=t.sent(),o="base64,",o=n.indexOf(o)+o.length,a=n.slice(o),[2,post("/face-actlive",__assign({video_b64:a},this.params)).then(function(t){return __assign(__assign({},t),{video_b64:a,recordBlob:e,videoB64:n})})]}})})},r}(),FaceFlashLiveDetector=function(){function a(){}return a.start=function(t,e){var e=e||15,n=new a,o=t._track;return n.frameRate=e,n.videoData=[],n.timer=setInterval(function(){var t=o.getCurrentFrameDataURL().replace("data:image/png;base64,","");n.videoData.push({image:t})},1e3/e),n},a.prototype.commit=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){return clearInterval(this.timer),[2,post("/face-flashlive",{video_data:this.videoData})]})})},a}();export{ActionType,AudioEncoding,AudioToTextAnalyzer,FaceActionLiveDetector,FaceFlashLiveDetector,IDCardDetector,image as ImageUtils,Speaker,Status,VideoType,defaultAudioToTextParams,faceComparer,faceDetector,init,textToSpeak,version};
