!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).QNRTCAI={})}(this,function(i){"use strict";var r=function(){return(r=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)};function t(e,r,s,u){return new(s=s||Promise)(function(n,t){function o(e){try{i(u.next(e))}catch(e){t(e)}}function a(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(o,a)}i((u=u.apply(e,r||[])).next())})}function s(n,o){var a,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;s;)try{if(a=1,i&&(r=2&t[0]?i.return:t[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,t[1])).done)return r;switch(i=0,(t=r?[2&t[0],r.value]:t)[0]){case 0:case 1:r=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!r||t[1]>r[0]&&t[1]<r[3])){s.label=t[1];break}if(6===t[0]&&s.label<r[1]){s.label=r[1],r=t;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(t);break}r[2]&&s.ops.pop(),s.trys.pop();continue}t=o.call(n,s)}catch(e){t=[6,e],i=0}finally{a=r=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function u(r,s){return new Promise(function(a){var i=new Image;i.src=r,i.onload=function(){var e,t,n=s.maxWidth,o=s.maxHeight;i.width*i.height>=n*o?(t=document.createElement("canvas"),e=Math.max(i.width/n,i.height/o),n=i.width/e,o=i.height/e,t.setAttribute("width",n+""),t.setAttribute("height",o+""),null!==(e=t.getContext("2d"))&&void 0!==e&&e.drawImage(i,0,0,n,o),t=t.toDataURL("image/png"),a(t)):a(r)}})}var e=Object.freeze({__proto__:null,compress:u}),n="https://ap-open-z0.qiniuapi.com/dora-sdk/api";function o(){this.cache={token:null}}var c=new(o.prototype.get=function(e){return this.cache[e]},o.prototype.set=function(e,t){this.cache[e]=t},o);function l(e,t){t=JSON.stringify({request:t||{}});return fetch(n+e,{headers:{Authorization:c.get("token"),"Content-Type":"application/json"},body:t,method:"POST"}).then(function(e){return e.json()})}var a=(d.run=function(e,t){return u(e._track.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640}).then(function(e){return l("/ocr-idcard",r({image:e.replace("data:image/png;base64,","")},t))})},d);function d(){}var f,h={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5};(w=f=f||{})[w.CLOSED=0]="CLOSED",w[w.PROCESSING=1]="PROCESSING",w[w.OPENED=2]="OPENED";var p=(v.prototype.initWebSocket=function(a,i){return t(this,void 0,void 0,function(){var t,n,o=this;return s(this,function(e){switch(e.label){case 0:return this.status=f.PROCESSING,c.cache.signCallback?[4,c.cache.signCallback(a)]:[3,2];case 1:return n=e.sent(),[3,3];case 2:n=null,e.label=3;case 3:return t=n,this.ws=new WebSocket(a+"&token="+t),this.on("open",function(){console.info("roomlog websocket open"),o.status=f.OPENED,i&&i()}),this.on("close",function(){console.info("roomlog websocket close"),o.status=f.CLOSED}),[2]}})})},v.prototype.on=function(e,t){var n;this.listeners.push({event:e,callback:t}),null!==(n=this.ws)&&void 0!==n&&n.addEventListener(e,t)},v.prototype.send=function(e){var t;this.status===f.OPENED&&null!==(t=this.ws)&&void 0!==t&&t.send(e)},v.prototype.sendEOS=function(){this.ws&&this.status===f.OPENED&&this.send("EOS")},v.prototype.close=function(){var e;this.ws&&this.status===f.OPENED&&(this.status=f.CLOSED,null!==(e=this.ws)&&void 0!==e&&e.close())},v.prototype.destroy=function(){var o=this;this.listeners.map(function(e){var t=e.event,n=e.callback;null!==(e=o.ws)&&void 0!==e&&e.removeEventListener(t,n)})},v);function v(e,t){this.status=f.CLOSED;var n=e.query,n=void 0===n?h:n,e=e.baseUrl,n=(void 0===e?"wss://ap-open-ws.service-z0.qiniuapp.com/asr":e)+"?"+Object.entries(r(r(r({},h),n),{e:Math.floor(Date.now()/1e3)})).filter(function(e){return void 0!==e[1]&&null!==e[1]}).map(function(e){return e[0]+"="+e[1]}).join("&");this.listeners=[],this.initWebSocket(n,t)}i.Status=void 0,(T=i.Status||(i.Status={}))[T.AVAILABLE=0]="AVAILABLE",T[T.DESTROY=1]="DESTROY",T[T.ERROR=2]="ERROR",T[T.DETECTING=3]="DETECTING";var m={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5},g=(b.prototype.startConnectWebSocket=function(t,e){var n=this,o=e.params,a=e.callback,e=e.audioBuffer,o=r(r(r({},m),{voice_sample:e.sampleRate}),o);t.ws=new p({query:o},function(){var e;t.isRecording=!0,t.status=i.Status.DETECTING,null!==(e=t.ws)&&void 0!==e&&e.on("message",function(e){var e=JSON.parse(e.data);null!=a&&a.onAudioToText&&a.onAudioToText(e),1===e.ended&&(n.timeoutWebSocketCloseJob&&clearTimeout(n.timeoutWebSocketCloseJob),null!==(e=t.ws)&&void 0!==e&&e.close())}),null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"正在实时转化"),null!==(e=t.ws)&&void 0!==e&&e.on("error",function(){t.isRecording=!1,t.status=i.Status.ERROR,null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"连接异常断线")}),null!==(e=t.ws)&&void 0!==e&&e.on("close",function(){t.isRecording=!1,t.status=i.Status.DESTROY,null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"已经销毁不可用")})}),t.ws.on("open",function(){var e;console.log("on open"),t.isRecording=!0,t.status=i.Status.DETECTING,null!==(e=t.ws)&&void 0!==e&&e.on("message",function(e){null!=a&&a.onAudioToText&&a.onAudioToText(JSON.parse(e.data))}),null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"正在实时转化")})},b.prototype.sendMessageToWebSocket=function(e,t){var n=t.audioBuffer;e.leftDataList.push(n.getChannelData(0).slice(0)),200<=Date.now()-e.startTime&&(t=this.mergeArray(e.leftDataList),n=Int16Array.from(t.map(function(e){return 0<e?32767*e:32768*e})).buffer,null!==(t=e.ws)&&void 0!==t&&t.send(n),e.startTime=Date.now(),e.leftDataList=[],e.rightDataList=[])},b.prototype.mergeArray=function(e){for(var t=e.length*e[0].length,n=new Float32Array(t),o=0,a=0;a<e.length;a++)n.set(e[a],o),o+=e[a].length;return n},b.prototype.interleaveLeftAndRight=function(e,t){for(var n=e.length+t.length,o=new Float32Array(n),a=0;a<e.length;a++){var i=2*a;o[i]=e[a],o[1+i]=t[a]}return o},b.startAudioToText=function(e,n,o){var t=e._track,a=new b;a.startTime=Date.now();e=function(e){var t;a.ws||a.startConnectWebSocket(a,{params:n,callback:o,audioBuffer:e}),(null===(t=a.ws)||void 0===t?void 0:t.status)===f.OPENED&&a.sendMessageToWebSocket(a,{audioBuffer:e})};return t.on("audioBuffer",e),a.audioBufferHandler=e,a.audioTrack=t,a},b.prototype.getStatus=function(){return this.status},b.prototype.stopAudioToText=function(){var e;this.audioTrack&&this.audioBufferHandler&&this.audioTrack.off("audioBuffer",this.audioBufferHandler),null!==(e=this.ws)&&void 0!==e&&e.sendEOS(),this.timeoutJob()},b.prototype.timeoutJob=function(e){var t=this;this.timeoutWebSocketCloseJob=setTimeout(function(){var e;null!==(e=t.ws)&&void 0!==e&&e.close()},e||500)},b);function b(){this.status=i.Status.AVAILABLE,this.isRecording=!1,this.startTime=Date.now(),this.leftDataList=[],this.rightDataList=[]}function y(e){return e.replace("data:image/png;base64,","")}i.Speaker=void 0,(w=i.Speaker||(i.Speaker={})).Male1="male1",w.Male2="male2",w.Female3="female3",w.Male4="male4",w.Female5="female5",w.Female6="female6",w.Kefu1="kefu1",w.Girl1="girl1",i.AudioEncoding=void 0,(T=i.AudioEncoding||(i.AudioEncoding={})).Wav="wav",T.Pcm="pcm",T.Mp3="mp3",i.ActionType=void 0,(w=i.ActionType||(i.ActionType={})).Nod="nod",w.Shake="shake",w.Blink="blink",w.Mouth="mouth",i.VideoType=void 0,(T=i.VideoType||(i.VideoType={}))[T.Mp4=1]="Mp4",T[T.H264=2]="H264";var w=(S.start=function(e,t,n){var o=new S,a="video/webm;codecs=h264",e=e.createMediaRecorder();if(!e.setMimeType(a))throw new TypeError("mime: "+a+" not supported");return o.recorder=e,o.recorder.start({videoTrack:t}),o.params=n,o},S.prototype.commit=function(){return t(this,void 0,void 0,function(){var t;return s(this,function(e){switch(e.label){case 0:return t=this.recorder.stop(),[4,(a=t,new Promise(function(t,n){var o=new FileReader;o.onload=function(e){t(e.target.result+"")},o.onerror=function(e){n("Failed to read file!\n\n"+o.error)},o.readAsDataURL(a)}))];case 1:return[2,l("/face-actlive",{video_b64:e.sent().replace("data:video/webm;codecs=h264;base64,",""),action_types:this.params.action_types,video_type:i.VideoType.H264})]}var a})})},S);function S(){}var T=(E.start=function(e,t){var t=t||15,n=new E,o=e._track;return n.frameRate=t,n.videoData=[],n.timer=setInterval(function(){var e=o.getCurrentFrameDataURL().replace("data:image/png;base64,","");n.videoData.push({image:e})},1e3/t),n},E.prototype.commit=function(){return t(this,void 0,void 0,function(){return s(this,function(e){return clearInterval(this.timer),[2,l("/face-flashlive",{video_data:this.videoData})]})})},E);function E(){}i.AudioToTextAnalyzer=g,i.FaceActionLiveDetector=w,i.FaceFlashLiveDetector=T,i.IDCardDetector=a,i.ImageUtils=e,i.defaultAudioToTextParams=m,i.faceComparer=function(e,o,a){var i=e._track;return t(this,void 0,void 0,function(){var t,n;return s(this,function(e){switch(e.label){case 0:return[4,u(i.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640})];case 1:return t=e.sent(),[4,u(o,{maxWidth:480,maxHeight:640})];case 2:return n=e.sent(),[2,l("/face-compare",r({data_uri_a:y(t),data_uri_b:y(n)},a))]}})})},i.faceDetector=function(e,t){return u(e._track.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640}).then(function(e){return l("/face-detect",r({image_b64:e.replace("data:image/png;base64,","")},t))})},i.init=function(e,t){c.set("token",e),c.set("signCallback",t)},i.textToSpeak=function(e){return l("/voice-tts",r({speaker:i.Speaker.Kefu1,audio_encoding:i.AudioEncoding.Wav,sample_rate:16e3,volume:50,speed:0},e))},i.version="1.0.8-beta",Object.defineProperty(i,"__esModule",{value:!0})});
