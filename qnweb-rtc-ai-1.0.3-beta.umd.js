!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).QNRTCAI={})}(this,function(e){"use strict";var o=function(){return(o=Object.assign||function(e){for(var t,n=1,a=arguments.length;n<a;n++)for(var o in t=arguments[n])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function t(e,r,s,u){return new(s=s||Promise)(function(n,t){function a(e){try{i(u.next(e))}catch(e){t(e)}}function o(e){try{i(u.throw(e))}catch(e){t(e)}}function i(e){var t;e.done?n(e.value):((t=e.value)instanceof s?t:new s(function(e){e(t)})).then(a,o)}i((u=u.apply(e,r||[])).next())})}function r(n,a){var o,i,r,s={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(r=2&t[0]?i.return:t[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,t[1])).done)return r;switch(i=0,(t=r?[2&t[0],r.value]:t)[0]){case 0:case 1:r=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(r=0<(r=s.trys).length&&r[r.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!r||t[1]>r[0]&&t[1]<r[3])){s.label=t[1];break}if(6===t[0]&&s.label<r[1]){s.label=r[1],r=t;break}if(r&&s.label<r[2]){s.label=r[2],s.ops.push(t);break}r[2]&&s.ops.pop(),s.trys.pop();continue}t=a.call(n,s)}catch(e){t=[6,e],i=0}finally{o=r=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}}function n(r,s){return new Promise(function(o){var i=new Image;i.src=r,i.onload=function(){var e,t,n=s.maxWidth,a=s.maxHeight;i.width*i.height>=n*a?(t=document.createElement("canvas"),e=Math.max(i.width/n,i.height/a),n=i.width/e,a=i.height/e,t.setAttribute("width",n+""),t.setAttribute("height",a+""),null!==(e=t.getContext("2d"))&&void 0!==e&&e.drawImage(i,0,0,n,a),t=t.toDataURL("image/png"),o(t)):o(r)}})}var a=Object.freeze({__proto__:null,compress:n}),i="https://ap-open-z0.qiniuapi.com/dora-sdk/api";function s(){this.cache={token:null}}var u=new(s.prototype.get=function(e){return this.cache[e]},s.prototype.set=function(e,t){this.cache[e]=t},s);function l(e,t){return fetch(i+e,{headers:{Authorization:u.get("token"),"Content-Type":"application/json"},body:JSON.stringify({request:t||{}}),method:"POST"}).then(function(e){return e.json()})}var c=(d.run=function(e,t){return n(e._track.getCurrentFrameDataURL(),{maxWidth:480,maxHeight:640}).then(function(e){return l("/ocr-idcard",o({image:e.replace("data:image/png;base64,","")},t))})},d);function d(){}var f,p={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5};(w=f=f||{})[w.CLOSED=0]="CLOSED",w[w.PROCESSING=1]="PROCESSING",w[w.OPENED=2]="OPENED";var h,v=(m.prototype.initWebSocket=function(o,i){return t(this,void 0,void 0,function(){var t,n,a=this;return r(this,function(e){switch(e.label){case 0:return this.status=f.PROCESSING,u.cache.signCallback?[4,u.cache.signCallback(o)]:[3,2];case 1:return n=e.sent(),[3,3];case 2:n=null,e.label=3;case 3:return t=n,this.ws=new WebSocket(o+"&token="+t),this.on("open",function(){console.info("roomlog websocket open"),a.status=f.OPENED,i&&i()}),this.on("close",function(){console.info("roomlog websocket close"),a.status=f.CLOSED}),[2]}})})},m.prototype.on=function(e,t){var n;this.listeners.push({event:e,callback:t}),null!==(n=this.ws)&&void 0!==n&&n.addEventListener(e,t)},m.prototype.send=function(e){var t;this.status===f.OPENED&&null!==(t=this.ws)&&void 0!==t&&t.send(e)},m.prototype.sendEOS=function(){this.ws&&this.status===f.OPENED&&(this.send("EOS"),this.status=f.CLOSED)},m.prototype.destroy=function(){var a=this;this.listeners.map(function(e){var t=e.event,n=e.callback;null!==(e=a.ws)&&void 0!==e&&e.removeEventListener(t,n)})},m);function m(e,t){this.status=f.CLOSED;var n=e.query,n=void 0===n?p:n,e=e.baseUrl,n=(void 0===e?"wss://ap-open-ws.service-z0.qiniuapp.com/asr":e)+"?"+Object.entries(o(o(o({},p),n),{e:Math.floor(Date.now()/1e3)})).filter(function(e){return void 0!==e[1]&&null!==e[1]}).map(function(e){return e[0]+"="+e[1]}).join("&");this.listeners=[],this.initWebSocket(n,t)}(C=h=h||{})[C.AVAILABLE=0]="AVAILABLE",C[C.DESTROY=1]="DESTROY",C[C.ERROR=2]="ERROR",C[C.DETECTING=3]="DETECTING";var g={voice_type:1,voice_encode:1,voice_sample:16e3,needvad:1,need_partial:1,maxsil:10,need_words:0,model_type:0,voice_id:void 0,force_final:0,vad_sil_thres:.5},w=(b.prototype.startConnectWebSocket=function(t,e){var n=e.params,a=e.callback,e=e.audioBuffer,n=o(o(o({},g),{voice_sample:e.sampleRate}),n);t.ws=new v({query:n},function(){var e;t.isRecording=!0,t.status=h.DETECTING,null!==(e=t.ws)&&void 0!==e&&e.on("message",function(e){null!=a&&a.onAudioToText&&a.onAudioToText(JSON.parse(e.data))}),null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"正在实时转化"),null!==(e=t.ws)&&void 0!==e&&e.on("error",function(){t.isRecording=!1,t.status=h.ERROR,null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"连接异常断线")}),null!==(e=t.ws)&&void 0!==e&&e.on("close",function(){t.isRecording=!1,t.status=h.DESTROY,null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"已经销毁不可用")})}),t.ws.on("open",function(){var e;console.log("on open"),t.isRecording=!0,t.status=h.DETECTING,null!==(e=t.ws)&&void 0!==e&&e.on("message",function(e){null!=a&&a.onAudioToText&&a.onAudioToText(JSON.parse(e.data))}),null!=a&&a.onStatusChange&&a.onStatusChange(t.status,"正在实时转化")})},b.prototype.sendMessageToWebSocket=function(e,t){var n,a,o=t.audioBuffer;e.preparedChannelData?(n=o.getChannelData(0),a=e.preparedChannelData,t=e.preparedChannelData.length+n.length,e.preparedChannelData=new Float32Array(t),e.preparedChannelData.set(a,0),e.preparedChannelData.set(n,a.length)):e.preparedChannelData=o.getChannelData(0),200<=Date.now()-e.startTime&&(a=Int16Array.from(e.preparedChannelData.map(function(e){return 0<e?32767*e:32768*e})).buffer,null!==(o=e.ws)&&void 0!==o&&o.send(a),e.startTime=Date.now(),e.preparedChannelData=null)},b.startAudioToText=function(e,n,a){var t=e._track,o=new b;o.startTime=Date.now();e=function(e){var t;o.ws||o.startConnectWebSocket(o,{params:n,callback:a,audioBuffer:e}),(null===(t=o.ws)||void 0===t?void 0:t.status)===f.OPENED&&o.sendMessageToWebSocket(o,{audioBuffer:e})};return t.on("audioBuffer",e),o.audioBufferHandler=e,o.audioTrack=t,o},b.prototype.getStatus=function(){return this.status},b.prototype.stopAudioToText=function(){var e;this.audioTrack&&this.audioBufferHandler&&this.audioTrack.off("audioBuffer",this.audioBufferHandler),null!==(e=this.ws)&&void 0!==e&&e.sendEOS()},b);function b(){this.status=h.AVAILABLE,this.preparedChannelData=null,this.isRecording=!1,this.startTime=Date.now()}var y,E,C;(C=y=y||{}).Male1="male1",C.Male2="male2",C.Female3="female3",C.Male4="male4",C.Female5="female5",C.Female6="female6",C.Kefu1="kefu1",C.Girl1="girl1",(C=E=E||{}).Wav="wav",C.Pcm="pcm",C.Mp3="mp3",e.AudioToTextAnalyzer=w,e.IDCardDetector=c,e.ImageUtils=a,e.init=function(e,t){u.set("token",e),u.set("signCallback",t)},e.textToSpeak=function(e){return l("/voice-tts",o({speaker:y.Kefu1,audio_encoding:E.Wav,sample_rate:16e3,volume:50,speed:0},e))},e.version="1.0.3-beta",Object.defineProperty(e,"__esModule",{value:!0})});
